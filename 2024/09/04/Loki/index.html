<!-- build time:Fri Sep 06 2024 11:36:51 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="//cdn.jsdelivr.net/gh/JoyseeKing/joyseeking.github.io@latest/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="//cdn.jsdelivr.net/gh/JoyseeKing/joyseeking.github.io@latest/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="Powered By Hexo&Shoka" href="http://joyseeking.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="Powered By Hexo&Shoka" href="http://joyseeking.github.io/atom.xml"><link rel="alternate" type="application/json" title="Powered By Hexo&Shoka" href="http://joyseeking.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/JoyseeKing/joyseeking.github.io@latest/css/app.css?v=0.2.5"><meta name="keywords" content="loki,grafana"><link rel="canonical" href="http://joyseeking.github.io/2024/09/04/Loki/"><title>Loki安装与采集流程 - Grafana - 日志 - 可观测性 | JoyseeKingの妙妙屋 = Powered By Hexo&Shoka = JoyseeKingの妙妙屋</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Loki安装与采集流程</h1><div class="meta"><span class="item" title="创建时间：2024-09-04 11:34:38"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2024-09-04T11:34:38+08:00">2024-09-04</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>4.7k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>4 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">JoyseeKingの妙妙屋</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://blog-1256634387.cos.ap-shanghai.myqcloud.com/6833939bly1giciundwu5j20zk0m8n9e.jpg"></li><li class="item" data-background-image="https://blog-1256634387.cos.ap-shanghai.myqcloud.com/6833939bly1giciryrr3rj20zk0m8nhk.jpg"></li><li class="item" data-background-image="https://blog-1256634387.cos.ap-shanghai.myqcloud.com/6833939bly1gipeuibk9fj20zk0m8ay2.jpg"></li><li class="item" data-background-image="https://blog-1256634387.cos.ap-shanghai.myqcloud.com/6833939bly1gipew28b65j20zk0m8hdt.jpg"></li><li class="item" data-background-image="https://blog-1256634387.cos.ap-shanghai.myqcloud.com/6833939bly1gipeun65urj20zk0m81ii.jpg"></li><li class="item" data-background-image="https://blog-1256634387.cos.ap-shanghai.myqcloud.com/6833939bly1gipeyonbf9j20zk0m8e81.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/" itemprop="item" rel="index" title="分类于 可观测性"><span itemprop="name">可观测性</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/%E6%97%A5%E5%BF%97/" itemprop="item" rel="index" title="分类于 日志"><span itemprop="name">日志</span></a><meta itemprop="position" content="2"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/%E6%97%A5%E5%BF%97/Grafana/" itemprop="item" rel="index" title="分类于 Grafana"><span itemprop="name">Grafana</span></a><meta itemprop="position" content="3"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://joyseeking.github.io/2024/09/04/Loki/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="//cdn.jsdelivr.net/gh/JoyseeKing/joyseeking.github.io@latest/images/avatar.jpg"><meta itemprop="name" content="JoyseeKing"><meta itemprop="description" content="JoyseeKingの妙妙屋, Iot cloud senior engineer, cyber dreamtist, code is warm </br> 物联网云端高级开发工程师 赛博理想主义者 代码是有温度的"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Powered By Hexo&Shoka"></span><div class="body md" itemprop="articleBody"><h1 id="helm安装loki以及使用promtail进行日志采集弹性集群"><a class="anchor" href="#helm安装loki以及使用promtail进行日志采集弹性集群">#</a> Helm 安装 Loki 以及使用 Promtail 进行日志采集（弹性集群）</h1><p>安装环境：阿里云 ACK 集群 k8s 版本 1.28 Worker 节点 3 推荐单节点 4C16G 以上</p><h2 id="helm更新"><a class="anchor" href="#helm更新">#</a> helm 更新</h2><p>首先更新 Helm 源</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>helm repo <span class="token function">add</span> grafana https://grafana.github.io/helm-charts</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>helm repo update</pre></td></tr></table></figure><h2 id="helm安装配置s3使用阿里云oss"><a class="anchor" href="#helm安装配置s3使用阿里云oss">#</a> helm 安装配置 s3（使用阿里云 OSS）</h2><p>阿里云 OSS 兼容 S3 的配置 需要提前创建三个 Loki 需要使用的 Bucket<br>分别名称为 xxx-chunks xxx-ruler xxx-admin</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">loki</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">commonConfig</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">replication_factor</span><span class="token punctuation">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">schemaConfig</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">configs</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span> <span class="token string">"2024-01-01"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token key atrule">store</span><span class="token punctuation">:</span> tsdb</pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token key atrule">index</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> loki_index_</pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token key atrule">period</span><span class="token punctuation">:</span> 24h *<span class="token comment">#这里设置 oss 内日志保留的日期 24h 30d</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token key atrule">object_store</span><span class="token punctuation">:</span> s3</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">schema</span><span class="token punctuation">:</span> v13</pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">storage</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">type</span><span class="token punctuation">:</span> s3</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">bucketNames</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">chunks</span><span class="token punctuation">:</span> xxx<span class="token punctuation">-</span>loki<span class="token punctuation">-</span>chunks</pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token key atrule">ruler</span><span class="token punctuation">:</span> xxx<span class="token punctuation">-</span>loki<span class="token punctuation">-</span>ruler</pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token key atrule">admin</span><span class="token punctuation">:</span> xxx<span class="token punctuation">-</span>loki<span class="token punctuation">-</span>admin</pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token key atrule">s3</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> oss<span class="token punctuation">-</span>cn<span class="token punctuation">-</span>beijing<span class="token punctuation">-</span>internal.aliyuncs.com  <span class="token comment">#阿里云的 endpoint 地址 这里用的内网因为在 VPC 内部署的 K8s 网络</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token key atrule">region</span><span class="token punctuation">:</span> cn<span class="token punctuation">-</span>beijing <span class="token comment">#region 不设置也可以</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token key atrule">secretAccessKey</span><span class="token punctuation">:</span> sxxxxxxxxxxxx  <span class="token comment">#SecretKey</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token key atrule">accessKeyId</span><span class="token punctuation">:</span> LTAxxxxxxxxxxxxxxxx <span class="token comment">#KeyId</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token key atrule">s3ForcePathStyle</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> </pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token key atrule">insecure</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token key atrule">deploymentMode</span><span class="token punctuation">:</span> SimpleScalable <span class="token comment">#部署模式选简单可伸缩</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token key atrule">backend</span><span class="token punctuation">:</span> <span class="token comment">#后端部署</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment">#副本数量</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token key atrule">persistence</span><span class="token punctuation">:</span> <span class="token comment">#这块是自定义挂载卷后面会解释为何这么配置</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token key atrule">storageClass</span><span class="token punctuation">:</span> alibabacloud<span class="token punctuation">-</span>cnfs<span class="token punctuation">-</span>nas</pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token key atrule">size</span><span class="token punctuation">:</span> 5Gi</pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token key atrule">read</span><span class="token punctuation">:</span> <span class="token comment">#只读 Pod</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token key atrule">write</span><span class="token punctuation">:</span> <span class="token comment">#写 Pod 这是个有状态副本</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token key atrule">persistence</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token key atrule">storageClass</span><span class="token punctuation">:</span> alibabacloud<span class="token punctuation">-</span>cnfs<span class="token punctuation">-</span>nas <span class="token comment">#这块是自定义挂载卷后面会解释为何这么配置</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token key atrule">size</span><span class="token punctuation">:</span> 5Gi</pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token key atrule">singleBinary</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token key atrule">minio</span><span class="token punctuation">:</span> <span class="token comment">#关闭 minio 存储 这是一个本地类似 S3 结构的文件存储库 不推荐线上使用</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token key atrule">ingester</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token key atrule">querier</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token key atrule">queryFrontend</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="48"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token key atrule">queryScheduler</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token key atrule">distributor</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token key atrule">compactor</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="54"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token key atrule">indexGateway</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="56"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token key atrule">bloomCompactor</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="58"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token key atrule">bloomGateway</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="60"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">0</span></pre></td></tr></table></figure><p>首先到文档列表中获取 Object Storage Configuration<br>链接贴上 <span class="exturl" data-url="aHR0cHM6Ly9ncmFmYW5hLmNvbS9kb2NzL2xva2kvbGF0ZXN0L3NldHVwL2luc3RhbGwvaGVsbS9pbnN0YWxsLXNjYWxhYmxlLw==">helm 安装弹性集群</span></p><p>一些详细的配置修改可以参考这个链接 <span class="exturl" data-url="aHR0cHM6Ly9ncmFmYW5hLmNvbS9kb2NzL2xva2kvbGF0ZXN0L3NldHVwL2luc3RhbGwvaGVsbS9yZWZlcmVuY2Uv">helm 安装 chart—values 设置</span></p><p>修改完之后将文件存储为 values.yaml 但现在不能直接应用需要考虑以下两个问题</p><h3 id="1阿里云设置卷对应的默认存储"><a class="anchor" href="#1阿里云设置卷对应的默认存储">#</a> 1. 阿里云设置卷对应的默认存储</h3><p>由于无状态的 backend 及有状态的 write 需要提供卷存储</p><p>backend 需要提供 BoltDB Shipper 的磁盘空间本地缓存数据 并定期上传至 S3 中</p><p>write 则需要将 log 数据暂存在磁盘中 写入数据库后清除缓存</p><p>由于以上问题 我们需要检查阿里云 ACK 中是否存在未使用的存储类 如有直接修改 value.yml 反之请创建存储类 大小建议在 20GB 以上 修改 value.yml 指定刚创建的的存储类名称</p><h3 id="2阿里云拉取镜像问题"><a class="anchor" href="#2阿里云拉取镜像问题">#</a> 2. 阿里云拉取镜像问题</h3><p>自 Docker 关闭中国境内的镜像源之后 大部分镜像都需要挂代理获取</p><p>现在的方案为 docker.io 内的镜像直接使用 DaoCloud 的镜像仓库 非 docker.io 的镜像将使用代理服务器或海外服务器拉取镜像并上传至私人 Docker Registy 仓库</p><p>我的方案代理服务器拉取的镜像 push 到将是阿里云的镜像仓库产品个人版 将 value.yml 对应的例如（loki.image.registry loki.image.repository） 镜像修改成阿里云镜像仓库的地址</p><p>当然可以尝试下更换 <a href="%22https://helm-charts.itboon.top/docs/grafana/loki-stack/%22">Helm Charts 仓库</a></p><h3 id="3配置免密组件sa豁免"><a class="anchor" href="#3配置免密组件sa豁免">#</a> 3. 配置免密组件 SA 豁免</h3><p>关于阿里云镜像问题还需要注意一个很重要的点 第三方 helm 安装的应用如果使用自己账号内镜像仓库的镜像 如果之前配置了免密插件拉取镜像 需要设置对应 SA 或者为豁免所有 SA 的使用组件的权限</p><p><img data-src="https://blog-1256634387.cos.ap-shanghai.myqcloud.com/content/1724910757336.jpg" alt="免密组件"></p><p>这个组件安装的位置在 kube-system 下 相关配置查看配置文件名称</p><p><img data-src="https://blog-1256634387.cos.ap-shanghai.myqcloud.com/content/1724919251442.jpg" alt="组件配置"></p><p>将 yaml 中 watch-namespace 修改成 all 并重启 acr 免密组件</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">data</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">acr-api-version</span><span class="token punctuation">:</span> <span class="token string">'2018-12-01'</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">acr-registry-info</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    - instanceId: ""</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">expiring-threshold</span><span class="token punctuation">:</span> 15m</pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">service-account</span><span class="token punctuation">:</span> <span class="token string">'*'</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">watch-namespace</span><span class="token punctuation">:</span> all</pre></td></tr></table></figure><h3 id="4关闭验证与x-scope-orgid"><a class="anchor" href="#4关闭验证与x-scope-orgid">#</a> 4. 关闭验证与 X-Scope-OrgID</h3><p>Grafana Loki 是一个多租户系统，不同租户之间的数据隔离，通过 X-Scope-OrgID 标识请求的租户。</p><p>Loki 默认以多租户模式运行 auth_enabled: true。promtail 和 Grafana 均需要验证才能访问</p><p>Grafana 租户查询隔离时，可以在 Grafana 设置 DataSource 中根据 HTTP 标头中的 X-Scope-OrgID 区分查询。</p><p>如果设置 auth_enabled: false Loki 将不进行验证 租户 ID 将设为 fake</p><h1 id="安装promtail-damonset"><a class="anchor" href="#安装promtail-damonset">#</a> 安装 Promtail Damonset</h1><p>设置 grafana helm 仓库</p><pre><code>helm repo add grafana https://grafana.github.io/helm-charts
helm repo update
</code></pre><p>设置 Loki 后端地址</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">config</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">clients</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//loki<span class="token punctuation">-</span>gateway/loki/api/v1/push</pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token key atrule">tenant_id</span><span class="token punctuation">:</span> <span class="token number">1</span></pre></td></tr></table></figure><p>安装 protail daemonset</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>helm upgrade --values values.yaml --install promtail grafana/promtail</pre></td></tr></table></figure><p>设置 Loki 限流<br>使用默认的 limits_config 的配置在 Loki 后端中会出现以下的的错误</p><pre><code>promptail-http-status-429-too-many-requests
msg=&quot;error sending batch, will retry&quot; status=429 error=&quot;server returned HTTP status 429 Too Many Requests (429): Maximum active stream limit exceeded, reduce the number of active streams
</code></pre><p>根据<span class="exturl" data-url="aHR0cHM6Ly9ncmFmYW5hLmNvbS9kb2NzL2xva2kvbGF0ZXN0L2NvbmZpZ3VyZS8jbGltaXRzX2NvbmZpZw==">限流配置</span>调整以下配置</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">limits_config</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token comment">#摄取器速率</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">ingestion_rate_mb</span><span class="token punctuation">:</span> <span class="token number">200</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token comment">#摄取器极限速率</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">ingestion_burst_size_mb</span><span class="token punctuation">:</span> <span class="token number">400</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  流</pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">per_stream_rate_limit</span><span class="token punctuation">:</span> 512MB</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">per_stream_rate_limit_burst</span><span class="token punctuation">:</span> 1024MB</pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">max_entries_limit_per_query</span><span class="token punctuation">:</span> <span class="token number">25000</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">max_query_parallelism</span><span class="token punctuation">:</span> <span class="token number">1024</span></pre></td></tr></table></figure><h1 id="安装grafana"><a class="anchor" href="#安装grafana">#</a> 安装 Grafana</h1><p>没什么好说的 helm 直接安装</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>helm <span class="token function">install</span> grafana grafana/grafana --namespace monitoring</pre></td></tr></table></figure><p>用以下指令获取 grafana 密码</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl get secret --namespace monitoring my-grafana -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">"&#123;.data.admin-password&#125;"</span> <span class="token operator">|</span> base64 --decode <span class="token punctuation">;</span> <span class="token builtin class-name">echo</span></pre></td></tr></table></figure><p>之后配置好 Loki 数据源就可以使用 Loki 查询日志了</p><h2 id="架构解释"><a class="anchor" href="#架构解释">#</a> 架构解释</h2><h3 id="loki-弹性架构"><a class="anchor" href="#loki-弹性架构">#</a> Loki 弹性架构</h3><p>Loki 弹性架构由一个复杂的读、写、存、缓存分离架构组成<br><img data-src="https://blog-1256634387.cos.ap-shanghai.myqcloud.com/content/0d0e4e2a76778d250a1d5cf830e19185.png" alt="弹性架构"></p><h4 id="1节点中的promtail-以daemonset的形式分布在各个节点-用于收集日志将日志push到loki中"><a class="anchor" href="#1节点中的promtail-以daemonset的形式分布在各个节点-用于收集日志将日志push到loki中">#</a> 1. 节点中的 Promtail 以 DaemonSet 的形式分布在各个节点 用于收集日志将日志 Push 到 Loki 中</h4><p>Promtail 会使用 fsnotify 监听指定目录下的日志文件的创建和删除</p><p>对活跃的日志文件会起一个 goroutine 进行类似 tail -f 的读取，读取到的内容发送给 channel</p><p>会有一个单独的 goroutine 读取 channel 中的日志行 分批处理并进行标签处理后 发送给 Loki</p><p><img data-src="https://blog-1256634387.cos.ap-shanghai.myqcloud.com/content/c783d414bf108d794d59ef6ab72ee7c9.jpeg" alt="promtail 工作流程"></p><h4 id="2loki内的写流程"><a class="anchor" href="#2loki内的写流程">#</a> 2.Loki 内的写流程</h4><p>在弹性模式内 gateway 接收到 promtail push 的日志内容之后 会由负载均衡到 write 的多副本中任一副本</p><p>write 副本中具有 Distributor 功能 根据日志中的 TenantID、Labels 计算 Hash 根据 Hash 值分发到不同的 Ingester 上 其次功能还包括验证数据格式 标签预处理 以及速率限制等功能</p><p>write 副本中的 Ingester 会构建及刷新 Chunk 块 所有的 Chunk 块会在本地磁盘缓存（TSDB 的形式） 只有达到容量上限后 Chunk 块设为只读 并发送至 S3 存储端进行存储 并清除指定的 Chuck 信息</p><h4 id="3index-tsdb缓存-memcached缓存与rulers"><a class="anchor" href="#3index-tsdb缓存-memcached缓存与rulers">#</a> 3.Index tsdb 缓存、Memcached 缓存与 Rulers</h4><p>backend 副本会定期到 S3 中下载文件并进行合并、压缩 上传新的 index 到 S3 上 并在本地保存 TSDB cache</p><p>索引网关服务负责处理和提供元数据查询。主要用于 query frontend 查询 Index-Gateway 中的 chunk 引用 其中一部分主要用于指标查询</p><p>memcached 缓存两部分数据一种为 result-cache（查询结果的缓存）和 chunk-cache（由 Ingester 存储后的完整 chunk 缓存） 并在内部维护淘汰策略</p><p>backend 副本中的 Rulers 提供类似 promthus 的 AlertManager 的报警策略 另一方面 ruler 会根据评估标准配置对 query frontend 进行评估</p><h4 id="4loki内的查询流程"><a class="anchor" href="#4loki内的查询流程">#</a> 4.Loki 内的查询流程</h4><p>Loki 的查询一般是 Grafana 前端发出 LogQL 后经由 Gateway 指向 read 副本</p><p>其中 read 副本的 Querier 会解析 LogQL 并从 IndexGateway 中获取索引信息</p><p>优先查询 memcached 的 cache 无法查询到后将指向 S3 中的对应分片进行查询 查询出的结果将会同步结果到 result-cache 以便提高下次查询的速度</p><p><img data-src="https://grafana.com/docs/loki/latest/get-started/scalable-monolithic-mode.png" alt="功能模式"></p><p><img data-src="https://aleiwu.com/img/loki/loki-arch.png" alt="Loki Overview"></p><h3 id="关于loki-canary"><a class="anchor" href="#关于loki-canary">#</a> 关于 Loki-Canary</h3><p>Loki-canary 是一个相对独立的组件、主要用于 Loki 集群性能的评估<br>Loki-canary 作为 DamonSet 分布在各个节点上 会定期生成日志行 这些日志行会被 Promtail 采集并按照正常流程被 Loki 处理</p><p>Loki-canary 生成的 log 行一般由时间戳及填充字符串构成，之后 Loki Canary 将打开与 Loki 的 WebSocket 连接，并跟踪它创建的日志。当在 WebSocket 上收到日志时，日志消息中的时间戳将与内部数组进行比较，用以评估 Loki 的性能指标。</p><p>Loki-canary 会定期进行抽查 确保曾经上报的日志信息并没有丢失</p><p>除此之外 Loki-canary 进行指标查询 count_over_time 验证 Loki 的日志速率是否与其创建的日志速率是否相对应</p><p><img data-src="https://grafana.com/docs/loki/latest/operations/loki-canary/loki-canary-block.png" alt="Loki-canary架构"></p><div class="tags"><a href="/tags/loki/" rel="tag"><i class="ic i-tag"></i> loki</a> <a href="/tags/grafana/" rel="tag"><i class="ic i-tag"></i> grafana</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2024-09-04 11:31:53" itemprop="dateModified" datetime="2024-09-04T11:31:53+08:00">2024-09-04</time> </span><span id="2024/09/04/Loki/" class="item leancloud_visitors" data-flag-title="Loki安装与采集流程" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="//cdn.jsdelivr.net/gh/JoyseeKing/joyseeking.github.io@latest/images/wechatpay.png" alt="JoyseeKing 微信支付"><p>微信支付</p></div><div><img data-src="//cdn.jsdelivr.net/gh/JoyseeKing/joyseeking.github.io@latest/images/alipay.png" alt="JoyseeKing 支付宝"><p>支付宝</p></div><div><img data-src="//cdn.jsdelivr.net/gh/JoyseeKing/joyseeking.github.io@latest/images/paypal.png" alt="JoyseeKing 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>JoyseeKing <i class="ic i-at"><em>@</em></i>Powered By Hexo&Shoka</li><li class="link"><strong>本文链接：</strong> <a href="http://joyseeking.github.io/2024/09/04/Loki/" title="Loki安装与采集流程">http://joyseeking.github.io/2024/09/04/Loki/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2024/09/04/Pytorch_multi/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;blog-1256634387.cos.ap-shanghai.myqcloud.com&#x2F;6833939bly1gipeudstjqj20zk0m8k3r.jpg" title="Pytorch多卡训练"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> Pytorch</span><h3>Pytorch多卡训练</h3></a></div><div class="item right"></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#helm%E5%AE%89%E8%A3%85loki%E4%BB%A5%E5%8F%8A%E4%BD%BF%E7%94%A8promtail%E8%BF%9B%E8%A1%8C%E6%97%A5%E5%BF%97%E9%87%87%E9%9B%86%E5%BC%B9%E6%80%A7%E9%9B%86%E7%BE%A4"><span class="toc-number">1.</span> <span class="toc-text">Helm 安装 Loki 以及使用 Promtail 进行日志采集（弹性集群）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#helm%E6%9B%B4%E6%96%B0"><span class="toc-number">1.1.</span> <span class="toc-text">helm 更新</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#helm%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEs3%E4%BD%BF%E7%94%A8%E9%98%BF%E9%87%8C%E4%BA%91oss"><span class="toc-number">1.2.</span> <span class="toc-text">helm 安装配置 s3（使用阿里云 OSS）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E9%98%BF%E9%87%8C%E4%BA%91%E8%AE%BE%E7%BD%AE%E5%8D%B7%E5%AF%B9%E5%BA%94%E7%9A%84%E9%BB%98%E8%AE%A4%E5%AD%98%E5%82%A8"><span class="toc-number">1.2.1.</span> <span class="toc-text">1. 阿里云设置卷对应的默认存储</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E9%98%BF%E9%87%8C%E4%BA%91%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F%E9%97%AE%E9%A2%98"><span class="toc-number">1.2.2.</span> <span class="toc-text">2. 阿里云拉取镜像问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E9%85%8D%E7%BD%AE%E5%85%8D%E5%AF%86%E7%BB%84%E4%BB%B6sa%E8%B1%81%E5%85%8D"><span class="toc-number">1.2.3.</span> <span class="toc-text">3. 配置免密组件 SA 豁免</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E5%85%B3%E9%97%AD%E9%AA%8C%E8%AF%81%E4%B8%8Ex-scope-orgid"><span class="toc-number">1.2.4.</span> <span class="toc-text">4. 关闭验证与 X-Scope-OrgID</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85promtail-damonset"><span class="toc-number">2.</span> <span class="toc-text">安装 Promtail Damonset</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85grafana"><span class="toc-number">3.</span> <span class="toc-text">安装 Grafana</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E8%A7%A3%E9%87%8A"><span class="toc-number">3.1.</span> <span class="toc-text">架构解释</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#loki-%E5%BC%B9%E6%80%A7%E6%9E%B6%E6%9E%84"><span class="toc-number">3.1.1.</span> <span class="toc-text">Loki 弹性架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E8%8A%82%E7%82%B9%E4%B8%AD%E7%9A%84promtail-%E4%BB%A5daemonset%E7%9A%84%E5%BD%A2%E5%BC%8F%E5%88%86%E5%B8%83%E5%9C%A8%E5%90%84%E4%B8%AA%E8%8A%82%E7%82%B9-%E7%94%A8%E4%BA%8E%E6%94%B6%E9%9B%86%E6%97%A5%E5%BF%97%E5%B0%86%E6%97%A5%E5%BF%97push%E5%88%B0loki%E4%B8%AD"><span class="toc-number">3.1.1.1.</span> <span class="toc-text">1. 节点中的 Promtail 以 DaemonSet 的形式分布在各个节点 用于收集日志将日志 Push 到 Loki 中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2loki%E5%86%85%E7%9A%84%E5%86%99%E6%B5%81%E7%A8%8B"><span class="toc-number">3.1.1.2.</span> <span class="toc-text">2.Loki 内的写流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3index-tsdb%E7%BC%93%E5%AD%98-memcached%E7%BC%93%E5%AD%98%E4%B8%8Erulers"><span class="toc-number">3.1.1.3.</span> <span class="toc-text">3.Index tsdb 缓存、Memcached 缓存与 Rulers</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4loki%E5%86%85%E7%9A%84%E6%9F%A5%E8%AF%A2%E6%B5%81%E7%A8%8B"><span class="toc-number">3.1.1.4.</span> <span class="toc-text">4.Loki 内的查询流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E4%BA%8Eloki-canary"><span class="toc-number">3.1.2.</span> <span class="toc-text">关于 Loki-Canary</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li class="active"><a href="/2024/09/04/Loki/" rel="bookmark" title="Loki安装与采集流程">Loki安装与采集流程</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="JoyseeKing" data-src="//cdn.jsdelivr.net/gh/JoyseeKing/joyseeking.github.io@latest/images/avatar.jpg"><p class="name" itemprop="name">JoyseeKing</p><div class="description" itemprop="description">Iot cloud senior engineer, cyber dreamtist, code is warm<br>物联网云端高级开发工程师 赛博理想主义者 代码是有温度的</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">8</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">13</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">11</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL0pveXNlZWtpbmc=" title="https:&#x2F;&#x2F;github.com&#x2F;Joyseeking"><i class="ic i-github"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS9qb3lzZWVraW5n" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;joyseeking"><i class="ic i-zhihu"></i></span> <span class="exturl item email" data-url="bWFpbHRvOkpveXNlZUtpbmcxQGdtYWlsLmNvbQ==" title="mailto:JoyseeKing1@gmail.com"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li></ul></div></div></div><ul id="quick"><li class="prev pjax"></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" title="分类于 中间件">中间件</a> <i class="ic i-angle-right"></i> <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/" title="分类于 链路追踪">链路追踪</a></div><span><a href="/2023/06/14/skywalking%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/" title="Skywalking 基本使用方式">Skywalking 基本使用方式</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E4%B8%AA%E4%BA%BA/" title="分类于 个人">个人</a></div><span><a href="/2023/06/13/Restart/" title="逃离上海">逃离上海</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E4%B8%AA%E4%BA%BA/" title="分类于 个人">个人</a> <i class="ic i-angle-right"></i> <a href="/categories/%E4%B8%AA%E4%BA%BA/%E7%BA%BF%E4%B8%8B%E5%B3%B0%E4%BC%9A/" title="分类于 线下峰会">线下峰会</a></div><span><a href="/2023/06/15/2023K+%E5%B3%B0%E4%BC%9A%E4%B8%8A%E6%B5%B7%E7%AB%99%E7%AE%80%E5%8D%95%E8%AE%B0%E5%BD%95/" title="2023K+峰会上海简单记录">2023K+峰会上海简单记录</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/" title="分类于 可观测性">可观测性</a> <i class="ic i-angle-right"></i> <a href="/categories/%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/%E6%97%A5%E5%BF%97/" title="分类于 日志">日志</a> <i class="ic i-angle-right"></i> <a href="/categories/%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/%E6%97%A5%E5%BF%97/Grafana/" title="分类于 Grafana">Grafana</a></div><span><a href="/2024/09/04/Loki/" title="Loki安装与采集流程">Loki安装与采集流程</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%A1%86%E6%9E%B6/" title="分类于 框架">框架</a></div><span><a href="/2021/09/10/skywalking%E7%9A%84Docker%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2/" title="Docker内部署SkyWalking">Docker内部署SkyWalking</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%89%8D%E7%AB%AF/" title="分类于 前端">前端</a></div><span><a href="/2021/09/10/Ubuntu_NodeJs%E5%AE%89%E8%A3%85%E4%B8%8E%E5%8D%87%E7%BA%A7/" title="Ubuntu NodeJs安装与升级">Ubuntu NodeJs安装与升级</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" title="分类于 分布式">分布式</a> <i class="ic i-angle-right"></i> <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E4%B8%AD%E9%97%B4%E4%BB%B6/" title="分类于 中间件">中间件</a></div><span><a href="/2023/06/14/etcd_%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0/" title="利用etcd实现分布式锁">利用etcd实现分布式锁</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" title="分类于 深度学习">深度学习</a> <i class="ic i-angle-right"></i> <a href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/Pytorch/" title="分类于 Pytorch">Pytorch</a></div><span><a href="/2024/09/04/Pytorch_multi/" title="Pytorch多卡训练">Pytorch多卡训练</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">JoyseeKing @ JoyseeKingの妙妙屋</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">23k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">21 分钟</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2024/09/04/Loki/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="//cdn.jsdelivr.net/gh/JoyseeKing/joyseeking.github.io@latest/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->